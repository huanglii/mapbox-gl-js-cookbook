import{_ as I,S as T,m as S}from"./base-map.vue_vue_type_style_index_0_lang-D9rQBs-7.js";import{g as C}from"./index-c_NJVKPv.js";import{d as g,r as E}from"./index-CaSe04H2.js";import{f as b,g as D,o as F,k as B}from"./app-DUPhFMc-.js";import{u as P,i as A,a as O,b as q,c as H}from"./installCanvasRenderer-BcqvXi2k.js";function R(M,_,w={}){var e=C(M),n=C(_),y=g(n[1]-e[1]),f=g(n[0]-e[0]),h=g(e[1]),u=g(n[1]),p=Math.pow(Math.sin(y/2),2)+Math.pow(Math.sin(f/2),2)*Math.cos(h)*Math.cos(u);return E(2*Math.atan2(Math.sqrt(p),Math.sqrt(1-p)),w.units)}var j=R;const U=b({__name:"pie",setup(M){P([A,O,q]);const _={style:T.GRAY,center:[107.744809,30.180706],zoom:6,minZoom:4},w=e=>{const n="point-source",f=new S.Popup({closeButton:!1,closeOnClick:!1,offset:[0,-40]});e.addSource(n,{type:"geojson",data:B("/data/point.geojson"),cluster:!0,clusterRadius:85}),e.addLayer({id:"earthquake_circle",type:"circle",source:n,paint:{"circle-radius":0}}),e.on("data",t=>{t.sourceId!==n||!t.isSourceLoaded||(e.on("move",p),e.on("moveend",p),p())});const h={};let u={};async function p(){const t={},c=e.querySourceFeatures(n),l=e.getSource(n);for(let o=0;o<c.length;o++){const r=c[o],d=r.geometry.coordinates;let s,a;r.properties&&r.properties.cluster?(s=r.properties.cluster_id,a=await x(s,l,r)):(a=r.properties,s=a.id);let i=h[s];i||(a.coords=d,i=h[s]=new S.Marker({element:k(a)}).setLngLat(d)),t[s]=i,u[s]||i.addTo(e)}for(const o in u)t[o]||u[o].remove();u=t}function k(t){const c=document.createElement("div");c.style.width="80px",c.style.height="80px";const l=H(c),{name:o,coords:r}=t;return l.setOption({title:{show:!0,text:o.length>4?`${o.substring(0,3)}··`:o,left:"center",top:"center",textStyle:{fontSize:12,textShadowBlur:5,textShadowColor:"#3EAF7C"},padding:0,shadowColor:"rgba(0, 0, 0, 0.5)",shadowBlur:10},color:["#FFD273","#E86D68","#A880FF"],series:[{type:"pie",name:`${o}|${r}`,radius:["40%","96%"],center:["50%","50%"],hoverAnimation:!1,label:{show:!0,position:"inside",formatter:"{c}"},labelLine:{show:!1},data:[{value:t.v1,name:"土豆"},{value:t.v2,name:"玉米"},{value:t.v3,name:"红薯"}]}]}),l.on("mouseover",d=>{const{seriesName:s,data:a}=d,i=s.split("|"),L=i[0],m=i[1].split(",").map($=>Number($)),v=`<p style="padding: 0 10px;">${L}: ${a.name} ${a.value} 万顷</p>`;f.setLngLat(m).setHTML(v).addTo(e)}),l.on("mouseout",()=>{f.remove()}),c}function x(t,c,l){return new Promise((o,r)=>{c.getClusterLeaves(t,30,0,(d,s)=>{d&&r(d);let a=1/0,i=0;for(let m=0;m<s.length;m++){const v=j(l,s[m]);v<a&&(i=m,a=v)}const L=s[i].properties;o(L)})})}};return(e,n)=>(F(),D(I,{"map-options":_,onLoad:w}))}});export{U as default};
