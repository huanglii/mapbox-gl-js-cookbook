import{b as T,S as k}from"./base-map-XmSAiI59.js";import{g as z,o as U,h as R,k as H,_ as B}from"./app-WXFCxs9o.js";import{e as O,l as N,_ as A,b as G}from"./mapbox-layer-G7PhuPL1.js";import{a as W,b as Y,C as X,d as j}from"./cpu-aggregator-nq36RmZL.js";var S=Math.PI/3,V=[0,S,2*S,3*S,4*S,5*S];function q(l){return l[0]}function K(l){return l[1]}function Z(){var l=0,e=0,n=1,a=1,u=q,o=K,s,i,g;function r(t){var h={},x=[],d,c=t.length;for(d=0;d<c;++d)if(!(isNaN(v=+u.call(null,f=t[d],d,t))||isNaN(p=+o.call(null,f,d,t)))){var f,v,p,y=Math.round(p=p/g),b=Math.round(v=v/i-(y&1)/2),M=p-y;if(Math.abs(M)*3>1){var P=v-b,F=b+(v<b?-1:1)/2,_=y+(p<y?-1:1),I=v-F,D=p-_;P*P+M*M>I*I+D*D&&(b=F+(y&1?1:-1)/2,y=_)}var w=b+"-"+y,C=h[w];C?C.push(f):(x.push(C=h[w]=[f]),C.x=(b+(y&1)/2)*i,C.y=y*g)}return x}function m(t){var h=0,x=0;return V.map(function(d){var c=Math.sin(d)*t,f=-Math.cos(d)*t,v=c-h,p=f-x;return h=c,x=f,[v,p]})}return r.hexagon=function(t){return"m"+m(t==null?s:+t).join("l")+"z"},r.centers=function(){for(var t=[],h=Math.round(e/g),x=Math.round(l/i),d=h*g;d<a+s;d+=g,++h)for(var c=x*i+(h&1)*i/2;c<n+i/2;c+=i)t.push([c,d]);return t},r.mesh=function(){var t=m(s).slice(0,4).join("l");return r.centers().map(function(h){return"M"+h+"m"+t}).join("")},r.x=function(t){return arguments.length?(u=t,r):u},r.y=function(t){return arguments.length?(o=t,r):o},r.radius=function(t){return arguments.length?(s=+t,i=s*2*Math.sin(S),g=s*1.5,r):s},r.size=function(t){return arguments.length?(l=e=0,n=+t[0],a=+t[1],r):[n-l,a-e]},r.extent=function(t){return arguments.length?(l=+t[0][0],e=+t[0][1],n=+t[1][0],a=+t[1][1],r):[[l,e],[n,a]]},r.radius(1)}function J(l,e){const{data:n,radius:a}=l,{viewport:u,attributes:o}=e,s=n.length?Q(n,e):null,i=$(a,u,s),g=[],{iterable:r,objectInfo:m}=O(n),t=o.positions.value,{size:h}=o.positions.getAccessor();for(const c of r){m.index++;const f=m.index*h,v=[t[f],t[f+1]];Number.isFinite(v[0])&&Number.isFinite(v[1])?g.push({screenCoord:u.projectFlat(v),source:c,index:m.index}):N.warn("HexagonLayer: invalid position")()}return{hexagons:Z().radius(i).x(c=>c.screenCoord[0]).y(c=>c.screenCoord[1])(g).map((c,f)=>({position:u.unprojectFlat([c.x,c.y]),points:c,index:f})),radiusCommon:i}}function Q(l,e){const{attributes:n}=e,a=n.positions.value,{size:u}=n.positions.getAccessor();let o=1/0,s=1/0,i=-1/0,g=-1/0,r;for(r=0;r<u*l.length;r+=u){const m=a[r],t=a[r+1];Number.isFinite(m)&&Number.isFinite(t)&&(o=Math.min(m,o),i=Math.max(m,i),s=Math.min(t,s),g=Math.max(t,g))}return[o,s,i,g].every(Number.isFinite)?[(o+i)/2,(s+g)/2]:null}function $(l,e,n){const{unitsPerMeter:a}=e.getDistanceScales(n);return l*a[0]}function E(){}const ee={colorDomain:null,colorRange:j,getColorValue:{type:"accessor",value:null},getColorWeight:{type:"accessor",value:1},colorAggregation:"SUM",lowerPercentile:{type:"number",value:0,min:0,max:100},upperPercentile:{type:"number",value:100,min:0,max:100},colorScaleType:"quantize",onSetColorDomain:E,elevationDomain:null,elevationRange:[0,1e3],getElevationValue:{type:"accessor",value:null},getElevationWeight:{type:"accessor",value:1},elevationAggregation:"SUM",elevationLowerPercentile:{type:"number",value:0,min:0,max:100},elevationUpperPercentile:{type:"number",value:100,min:0,max:100},elevationScale:{type:"number",min:0,value:1},elevationScaleType:"linear",onSetElevationDomain:E,radius:{type:"number",value:1e3,min:1},coverage:{type:"number",min:0,max:1,value:1},extruded:!1,hexagonAggregator:J,getPosition:{type:"accessor",value:l=>l.position},material:!0,_filterData:{type:"function",value:null,optional:!0}};class L extends W{constructor(...e){super(...e),A(this,"state",void 0)}initializeState(){const e=new Y({getAggregator:a=>a.hexagonAggregator,getCellSize:a=>a.radius});this.state={cpuAggregator:e,aggregatorState:e.state,vertices:null},this.getAttributeManager().add({positions:{size:3,type:5130,accessor:"getPosition"}})}updateState(e){if(super.updateState(e),e.changeFlags.propsOrDataChanged){const n=this.state.cpuAggregator.updateState(e,{viewport:this.context.viewport,attributes:this.getAttributes()});if(this.state.aggregatorState.layerData!==n.layerData){const{hexagonVertices:a}=n.layerData||{};this.setState({vertices:a&&this.convertLatLngToMeterOffset(a)})}this.setState({aggregatorState:n})}}convertLatLngToMeterOffset(e){const{viewport:n}=this.context;if(Array.isArray(e)&&e.length===6){const a=e[0],u=e[3],o=[(a[0]+u[0])/2,(a[1]+u[1])/2],s=n.projectFlat(o),{metersPerUnit:i}=n.getDistanceScales(o);return e.map(r=>{const m=n.projectFlat(r);return[(m[0]-s[0])*i[0],(m[1]-s[1])*i[1]]})}return N.error("HexagonLayer: hexagonVertices needs to be an array of 6 points")(),null}getPickingInfo({info:e}){return this.state.cpuAggregator.getPickingInfo({info:e})}_onGetSublayerColor(e){return this.state.cpuAggregator.getAccessor("fillColor")(e)}_onGetSublayerElevation(e){return this.state.cpuAggregator.getAccessor("elevation")(e)}_getSublayerUpdateTriggers(){return this.state.cpuAggregator.getUpdateTriggers(this.props)}renderLayers(){const{elevationScale:e,extruded:n,coverage:a,material:u,transitions:o}=this.props,{aggregatorState:s,vertices:i}=this.state,g=this.getSubLayerClass("hexagon-cell",X),r=this._getSublayerUpdateTriggers(),m=i?{vertices:i,radius:1}:{radius:s.layerData.radiusCommon||1,radiusUnits:"common",angle:90};return new g({...m,diskResolution:6,elevationScale:e,extruded:n,coverage:a,material:u,getFillColor:this._onGetSublayerColor.bind(this),getElevation:this._onGetSublayerElevation.bind(this),transitions:o&&{getFillColor:o.getColorValue||o.getColorWeight,getElevation:o.getElevationValue||o.getElevationWeight}},this.getSubLayerProps({id:"hexagon-cell",updateTriggers:r}),{data:s.layerData.data})}}A(L,"layerName","HexagonLayer");A(L,"defaultProps",ee);const te=z({__name:"hexagon-layer",setup(l){const e={style:k.DARK,center:[-122.441107,37.755579],zoom:11.4,minZoom:8,pitch:50,antialias:!0},n=a=>{const u=new G({id:"hexagon-layer",type:L,data:H("/data/sf-bike-parking.json"),pickable:!0,extruded:!0,radius:100,elevationScale:5,colorRange:[[1,152,189],[73,227,206],[216,254,181],[254,237,177],[254,173,84],[209,55,78]],getPosition:o=>o.COORDINATES});a.addLayer(u)};return(a,u)=>(U(),R(T,{"map-clickable":!1,"map-options":e,onLoad:n}))}}),ie=B(te,[["__file","hexagon-layer.vue"]]);export{ie as default};
